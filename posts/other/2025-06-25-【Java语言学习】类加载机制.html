<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã€Javaè¯­è¨€å­¦ä¹ ã€‘ç±»åŠ è½½æœºåˆ¶ | Focusmee</title>
    <meta name="description" content="ã€Javaè¯­è¨€å­¦ä¹ ã€‘ç±»åŠ è½½æœºåˆ¶">
    <meta property="og:title" content="ã€Javaè¯­è¨€å­¦ä¹ ã€‘ç±»åŠ è½½æœºåˆ¶">
    <meta property="og:description" content="ã€Javaè¯­è¨€å­¦ä¹ ã€‘ç±»åŠ è½½æœºåˆ¶">
    <meta property="og:type" content="article">
    <link rel="stylesheet" href="../../styles/fonts.css">
    <link rel="stylesheet" href="../../styles/icons.css">
    <link rel="stylesheet" href="../../styles/highlight.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <link rel="stylesheet" href="../../styles/post.css">
</head>
<body>
    <!-- Navigation -->
    <nav class="nav">
        <div class="nav-container">
            <div class="nav-logo">
                <a href="../../index.html" class="logo-link">
                    <span class="logo-text">Focusmee</span>
                    <div class="logo-subtitle">å…¨æ ˆå¼€å‘å·¥ç¨‹å¸ˆ</div>
                </a>
            </div>
            <div class="nav-menu">
                <a href="../../index.html#about" class="nav-link">å…³äº</a>
                <a href="../../index.html#work" class="nav-link">é¡¹ç›®</a>
                <a href="../../blog.html" class="nav-link">åšå®¢</a>
                <a href="../../index.html#contact" class="nav-link">è”ç³»</a>
                <div class="nav-social">
                    <a href="https://github.com/Focusmee" target="_blank" class="social-link">
                        <i class="fab fa-github"></i>
                    </a>
                    <a href="mailto:2105735259@qq.com" class="social-link">
                        <i class="fas fa-envelope"></i>
                    </a>
                </div>
            </div>
        </div>
    </nav>

    <!-- Reading Toolbar -->
    <div id="readingToolbar" class="reading-toolbar">
        <div class="toolbar-handle">
            <i class="fas fa-bars"></i>
        </div>
        <div class="toolbar-content">
            <div class="toolbar-header">
                <h4>é˜…è¯»å·¥å…·</h4>
                <button class="toolbar-toggle" title="å±•å¼€/æ”¶èµ·">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div class="toolbar-controls">
                <div class="control-group">
                    <label>å­—ä½“å¤§å°</label>
                    <div class="font-size-controls">
                        <button class="font-btn" data-action="decrease">A-</button>
                        <span class="font-size-display">16px</span>
                        <button class="font-btn" data-action="increase">A+</button>
                    </div>
                </div>
                <div class="control-group">
                    <label>ä¸»é¢˜æ¨¡å¼</label>
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                        <span>æ·±è‰²æ¨¡å¼</span>
                    </button>
                </div>
                <div class="control-group">
                    <label>é˜…è¯»è¿›åº¦</label>
                    <div class="reading-progress-info">
                        <span id="readingPercentage">0%</span>
                        <div class="progress-bar-mini">
                            <div class="progress-fill-mini"></div>
                        </div>
                    </div>
                </div>
                <div class="control-group">
                    <button class="tool-btn" id="shareBtn">
                        <i class="fas fa-share-alt"></i>
                        <span>åˆ†äº«æ–‡ç« </span>
                    </button>
                </div>
                <div class="control-group">
                    <button class="tool-btn" id="printBtn">
                        <i class="fas fa-print"></i>
                        <span>æ‰“å°æ–‡ç« </span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Post Content -->
    <article class="post">
        <div class="container">
            <header class="post-header">
                <nav class="breadcrumb">
                    <a href="../../blog.html">åšå®¢</a>
                    <span class="separator">/</span>
                    <span class="category-breadcrumb">å…¶ä»–</span>
                    <span class="separator">/</span>
                    <span class="current">ã€Javaè¯­è¨€å­¦ä¹ ã€‘ç±»åŠ è½½æœºåˆ¶</span>
                </nav>
                
                <div class="post-meta">
                    <time class="post-date">2025/6/25 08:00:00</time>
                    <span class="post-category">å…¶ä»–</span>
                    <span class="post-read-time">54 åˆ†é’Ÿé˜…è¯»</span>
                </div>
                
                <h1 class="post-title">ã€Javaè¯­è¨€å­¦ä¹ ã€‘ç±»åŠ è½½æœºåˆ¶</h1>
                
                <div class="post-tags">
                    
                </div>
            </header>
            
            <div class="post-content">
                <h1>ã€Javaè¯­è¨€å­¦ä¹ ã€‘ç±»åŠ è½½æœºåˆ¶</h1>
<h2>å‰ç½®çŸ¥è¯†</h2>
<h3>ğŸ§  1. <strong>æ‡’åŠ è½½ï¼ˆLazy Loadingï¼‰</strong></h3>
<p><strong>æ¦‚å¿µ</strong>ï¼šæ‡’åŠ è½½æ˜¯æŒ‡<strong>å»¶è¿ŸåŠ è½½ç±»æˆ–å¯¹è±¡ï¼Œç›´åˆ°çœŸæ­£éœ€è¦ç”¨åˆ°æ—¶æ‰åŠ è½½æˆ–åˆå§‹åŒ–</strong>ï¼Œä»¥èŠ‚çœèµ„æºã€åŠ å¿«å¯åŠ¨é€Ÿåº¦ã€‚</p>
<p><strong>åœ¨ç±»åŠ è½½ä¸­ä½“ç°</strong>ï¼š</p>
<ul>
<li>Java ä¸­ï¼Œç±»çš„åŠ è½½æ˜¯æŒ‰éœ€è§¦å‘çš„ã€‚</li>
<li><strong>é™æ€å†…éƒ¨ç±»å®ç°å•ä¾‹æ¨¡å¼</strong>å°±ç”¨åˆ°äº†æ‡’åŠ è½½ï¼š</li>
</ul>
<pre><code class="language-java">public class Singleton {
    private Singleton() {}
    private static class Holder {
        private static final Singleton INSTANCE = new Singleton();
    }
    public static Singleton getInstance() {
        return Holder.INSTANCE; // ç¬¬ä¸€æ¬¡è°ƒç”¨æ‰ä¼šåŠ è½½ Holder ç±»
    }
}
</code></pre>
<p>æ¯”å¦‚Launcherå°±æ˜¯æ‡’åŠ è½½</p>
<h3>ğŸ”’ 2. <strong>é‡å…¥é”ï¼ˆReentrantLockï¼‰</strong></h3>
<p><strong>æ¦‚å¿µ</strong>ï¼šJava ä¸­çš„ <code>ReentrantLock</code> æ˜¯ <code>java.util.concurrent.locks</code> åŒ…ä¸­çš„ä¸€ç§<strong>å¯é‡å…¥çš„æ˜¾å¼é”</strong>ï¼Œç”¨äºä»£æ›¿ <code>synchronized</code> å®ç°æ›´çµæ´»çš„çº¿ç¨‹åŒæ­¥æ§åˆ¶ã€‚</p>
<p><strong>ç‰¹ç‚¹</strong>ï¼š</p>
<ul>
<li><strong>å¯é‡å…¥</strong>ï¼šåŒä¸€çº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–é”è€Œä¸ä¼šæ­»é”ã€‚</li>
<li>æä¾›å¯ä¸­æ–­ã€è¶…æ—¶ã€å…¬å¹³é”ã€éå…¬å¹³é”ç­‰é«˜çº§åŠŸèƒ½ã€‚</li>
</ul>
<pre><code>ReentrantLock lock = new ReentrantLock();
lock.lock(); // åŠ é”
try {
    // ä¸´ç•ŒåŒº
} finally {
    lock.unlock(); // è§£é”
}
</code></pre>
<h3>ğŸ§µ 3. <strong>ParallelCapableClassLoader / Parallel ç±»åŠ è½½å™¨</strong></h3>
<p> <strong>Parallel Capable ClassLoader</strong>ã€‚è¿™æ˜¯ä¸ºäº†è®©<strong>ç±»åŠ è½½å™¨å¹¶å‘åŠ è½½ç±»</strong>è€Œè®¾è®¡çš„ã€‚</p>
<h4>ä¸ºä»€ä¹ˆéœ€è¦å®ƒï¼Ÿ</h4>
<p>ä¼ ç»Ÿçš„ç±»åŠ è½½å™¨ç»“æ„æ˜¯æ ‘å½¢çš„ï¼Œå¤šä¸ªçº¿ç¨‹åŒæ—¶åŠ è½½ç±»æ—¶å¯èƒ½ä¼šäº‰ç”¨åŒä¸€ä¸ªç±»åŠ è½½å™¨çš„é”ï¼Œå¯¼è‡´æ€§èƒ½ä¸‹é™ã€‚</p>
<h4>Java 7 å¼•å…¥ï¼š</h4>
<ul>
<li><code>ClassLoader.registerAsParallelCapable()</code> é™æ€æ–¹æ³•ã€‚</li>
<li>å®ƒå…è®¸è‡ªå®šä¹‰ç±»åŠ è½½å™¨å¹¶å‘åŠ è½½å¤šä¸ªç±»ï¼Œè€Œä¸éœ€è¦é”ä½æ•´ä¸ªåŠ è½½å™¨ã€‚</li>
</ul>
<h4>ç±»åŠ è½½è¿‡ç¨‹ä¸­çš„â€œåªåŠ è½½ä¸€æ¬¡â€ï¼š</h4>
<ul>
<li>JVM ä¿è¯ï¼š<strong>ä¸€ä¸ªç±»åœ¨ä¸€ä¸ªç±»åŠ è½½å™¨ä¸­åªä¼šè¢«åŠ è½½ä¸€æ¬¡</strong>ã€‚</li>
<li>JVM ä¼šç”¨ä¸€ä¸ª <code>defineClass()</code> æ–¹æ³•æ¥å®šä¹‰ç±»ï¼Œå¦‚æœå·²ç»åŠ è½½è¿‡å°±ä¸å†é‡å¤å®šä¹‰ã€‚</li>
<li>åŠ è½½æ—¶ä½¿ç”¨äº†é”å’Œä¸€äº›å¹¶å‘ç­–ç•¥ï¼ˆå¦‚ä¸Šé¢çš„ ParallelCapableï¼‰æ¥ä¿è¯çº¿ç¨‹å®‰å…¨å’Œæ•ˆç‡ã€‚</li>
</ul>
<h3>ğŸ“Œ æ€»ç»“</h3>
<table>
<thead>
<tr>
<th>åç§°</th>
<th>ä½œç”¨</th>
<th>å…³é”®è¯</th>
</tr>
</thead>
<tbody><tr>
<td><strong>æ‡’åŠ è½½</strong></td>
<td>å»¶è¿Ÿç±»æˆ–å¯¹è±¡åˆå§‹åŒ–</td>
<td>èŠ‚çœèµ„æº</td>
</tr>
<tr>
<td><strong>é‡å…¥é”</strong></td>
<td>å¯æ§åˆ¶çš„çº¿ç¨‹åŒæ­¥å·¥å…·</td>
<td><code>ReentrantLock</code></td>
</tr>
<tr>
<td><strong>ParallelCapableClassLoader</strong></td>
<td>å…è®¸ç±»åŠ è½½å™¨å¹¶å‘åŠ è½½å¤šä¸ªç±»</td>
<td>æé«˜åŠ è½½æ•ˆç‡ï¼Œé¿å…åŒæ­¥é˜»å¡</td>
</tr>
</tbody></table>
<h2>LoadClassæµç¨‹</h2>
<h3>URLClassLoaderçš„findClassï¼ˆå†³å®šè‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½æ–¹æ³•ï¼‰</h3>
<p>ä½ æ­£åœ¨çœ‹çš„æ˜¯ Java ç±»åŠ è½½å™¨ä¸­çš„æ ¸å¿ƒæ–¹æ³• <code>findClass</code> çš„ä¸€ç§å®ç°ï¼ˆæ¯”å¦‚åœ¨ <code>URLClassLoader</code> ä¸­ï¼‰ã€‚è¿™ä¸ªæ–¹æ³•æ˜¯å½“ç±»æ²¡æœ‰åœ¨ç¼“å­˜ä¸­ï¼Œä¹Ÿæ²¡è¢«çˆ¶åŠ è½½å™¨åŠ è½½æˆåŠŸæ—¶ï¼Œç”±<strong>å½“å‰ç±»åŠ è½½å™¨â€œè‡ªå·±â€è´Ÿè´£åŠ è½½ç±»</strong>çš„é€»è¾‘ã€‚</p>
<p>æˆ‘ä»¬æ¥<strong>é€è¡Œæ‹†è§£è®²è§£</strong>è¿™æ®µä»£ç çš„ä½œç”¨å’ŒåŸç†ã€‚</p>
<hr>
<h4>ğŸ” æ–¹æ³•ç­¾å</h4>
<pre><code class="language-java">protected Class&lt;?&gt; findClass(final String name) throws ClassNotFoundException
</code></pre>
<ul>
<li>å­ç±»å¯ä»¥é‡å†™è¯¥æ–¹æ³•ï¼Œè‡ªå®šä¹‰ç±»çš„åŠ è½½æ–¹å¼ã€‚</li>
<li>æ¥æ”¶ç±»çš„å…¨é™å®šåï¼Œæ¯”å¦‚ï¼š<code>com.example.MyClass</code>ã€‚</li>
<li>è‹¥æ‰¾ä¸åˆ°ç±»ï¼Œåˆ™æŠ›å‡º <code>ClassNotFoundException</code>ã€‚</li>
</ul>
<hr>
<h4>1ï¸âƒ£ <code>AccessController.doPrivileged(...)</code></h4>
<pre><code class="language-java">result = AccessController.doPrivileged(
</code></pre>
<p>ğŸ” <strong>ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆå†™ï¼Ÿ</strong></p>
<ul>
<li>åœ¨ Java å®‰å…¨æ²™ç®±æ¨¡å‹ä¸­ï¼Œå¦‚æœåŠ è½½ç±»çš„è·¯å¾„æ˜¯å—é™çš„ï¼ˆå¦‚è¯»å–æ–‡ä»¶ã€Jarã€ç½‘ç»œèµ„æºï¼‰ï¼Œå¿…é¡»ä½¿ç”¨ <code>doPrivileged()</code> æ‰§è¡Œæ“ä½œï¼Œé¿å…æƒé™è¢«é™åˆ¶ã€‚</li>
<li><code>doPrivileged()</code> ä¼šåœ¨ä¸€ä¸ªå—ä¿¡ä»»çš„æƒé™ä¸Šä¸‹æ–‡ä¸­æ‰§è¡Œä»£ç ã€‚</li>
</ul>
<hr>
<h4>2ï¸âƒ£ å†…éƒ¨ PrivilegedExceptionAction çš„å®ç°</h4>
<pre><code class="language-java">new PrivilegedExceptionAction&lt;Class&lt;?&gt;&gt;() {
    public Class&lt;?&gt; run() throws ClassNotFoundException {
        ...
    }
}
</code></pre>
<p>è¿™æ˜¯ä¸€ä¸ª<strong>åŒ¿åå†…éƒ¨ç±»</strong>ï¼Œæ˜¯ <code>doPrivileged()</code> æ‰€éœ€çš„ä»»åŠ¡ä½“ã€‚æ ¸å¿ƒé€»è¾‘éƒ½åœ¨ <code>run()</code> æ–¹æ³•ä¸­ã€‚</p>
<hr>
<h4>3ï¸âƒ£ æ„å»ºç±»æ–‡ä»¶è·¯å¾„</h4>
<pre><code class="language-java">String path = name.replace(&#39;.&#39;, &#39;/&#39;).concat(&quot;.class&quot;);
</code></pre>
<ul>
<li>æŠŠç±»åè½¬æ¢æˆæ–‡ä»¶è·¯å¾„ã€‚</li>
<li>æ¯”å¦‚ <code>java.lang.String</code> â†’ <code>java/lang/String.class</code></li>
</ul>
<hr>
<h4>4ï¸âƒ£ å°è¯•è·å–èµ„æº</h4>
<pre><code class="language-java">Resource res = ucp.getResource(path, false);
</code></pre>
<ul>
<li><code>ucp</code> é€šå¸¸æ˜¯ <code>URLClassPath</code> ç±»å‹ï¼Œè´Ÿè´£æ ¹æ®ç±»è·¯å¾„ï¼ˆclasspath/jar/urlï¼‰å»æ‰¾èµ„æºã€‚</li>
<li><code>getResource(path, false)</code> ä¼šå°è¯•åŠ è½½ <code>.class</code> æ–‡ä»¶èµ„æºã€‚</li>
</ul>
<p>å¦‚æœæ‰¾åˆ°äº†ï¼Œå°±è¿›å…¥å®šä¹‰æµç¨‹ï¼›å¦åˆ™è¿”å› <code>null</code>ã€‚</p>
<hr>
<h4>5ï¸âƒ£ è¯»å–å¹¶å®šä¹‰ç±»</h4>
<pre><code class="language-java">return defineClass(name, res);
</code></pre>
<ul>
<li><code>defineClass(...)</code> æ˜¯ <code>ClassLoader</code> çš„æ–¹æ³•ï¼š<ul>
<li>ä¼šä» <code>.class</code> æ–‡ä»¶ä¸­è¯»å–å­—èŠ‚æ•°ç»„ï¼Œè¿›è¡Œæ ¡éªŒï¼Œæœ€ç»ˆè½¬æ¢ä¸º JVM ä¸­çš„ <code>Class&lt;?&gt;</code> å¯¹è±¡ã€‚</li>
</ul>
</li>
<li>å¦‚æœ <code>IOException</code> æˆ– <code>ClassFormatError</code>ï¼Œè¯´æ˜ç±»æ–‡ä»¶æŸåæˆ–éæ³•ã€‚</li>
</ul>
<pre><code class="language-java">} catch (IOException e) {
    throw new ClassNotFoundException(name, e);
}
</code></pre>
<ul>
<li>å°† I/O å¼‚å¸¸åŒ…è£…ä¸º <code>ClassNotFoundException</code> æŠ›å‡ºã€‚</li>
</ul>
<pre><code class="language-java">} catch (ClassFormatError e2) {
    if (res.getDataError() != null) {
        e2.addSuppressed(res.getDataError());
    }
    throw e2;
}
</code></pre>
<ul>
<li><code>ClassFormatError</code> æ˜¯æ ¼å¼éæ³•çš„å­—èŠ‚ç ï¼›</li>
<li>å¦‚æœ <code>Resource</code> è®°å½•äº†é¢å¤–çš„æ•°æ®å¼‚å¸¸ï¼Œä¹Ÿä¸€èµ·é™„åŠ åˆ°å¼‚å¸¸ä¸­ï¼ˆJava 7 çš„ suppressed å¼‚å¸¸æœºåˆ¶ï¼‰ã€‚</li>
</ul>
<hr>
<h4>6ï¸âƒ£ å¤–å±‚å¼‚å¸¸å¤„ç†</h4>
<pre><code class="language-java">} catch (java.security.PrivilegedActionException pae) {
    throw (ClassNotFoundException) pae.getException();
}
</code></pre>
<ul>
<li><code>doPrivileged()</code> åŒ…è£¹çš„æ˜¯å¯èƒ½æŠ›å‡ºå¼‚å¸¸çš„åŠ¨ä½œï¼Œæ‰€ä»¥ç”¨ <code>PrivilegedActionException</code> æ•è·ï¼›</li>
<li>è§£åŒ…åæŠ›å‡ºåŸå§‹çš„ <code>ClassNotFoundException</code>ã€‚</li>
</ul>
<hr>
<h4>7ï¸âƒ£ åˆ¤æ–­è¿”å›ç»“æœ</h4>
<pre><code class="language-java">if (result == null) {
    throw new ClassNotFoundException(name);
}
</code></pre>
<ul>
<li>å¦‚æœèµ„æºå‹æ ¹æ²¡æ‰¾åˆ°ï¼Œ<code>ucp.getResource</code> è¿”å› nullï¼Œé‚£ä¹ˆæœ€ç»ˆä¹Ÿè¦æŠ›å‡ºæ‰¾ä¸åˆ°ç±»ã€‚</li>
</ul>
<hr>
<h4>âœ… æœ€ç»ˆè¿”å›</h4>
<pre><code class="language-java">return result;
</code></pre>
<hr>
<h4>ğŸ”š æ€»ç»“ï¼šæ•´ä¸ªæµç¨‹å¦‚ä¸‹ï¼š</h4>
<table>
<thead>
<tr>
<th>æ­¥éª¤</th>
<th>å†…å®¹</th>
</tr>
</thead>
<tbody><tr>
<td>1ï¸âƒ£</td>
<td>è½¬æ¢ç±»åä¸ºè·¯å¾„ <code>com.A.B</code> â†’ <code>com/A/B.class</code></td>
</tr>
<tr>
<td>2ï¸âƒ£</td>
<td>é€šè¿‡ <code>ucp</code> æŸ¥æ‰¾èµ„æºï¼ˆå¯èƒ½æ˜¯ jar æˆ–æœ¬åœ°è·¯å¾„ï¼‰</td>
</tr>
<tr>
<td>3ï¸âƒ£</td>
<td>æ‰¾åˆ°åè¯»å–å­—èŠ‚ç ï¼Œè°ƒç”¨ <code>defineClass</code> å®šä¹‰ç±»</td>
</tr>
<tr>
<td>4ï¸âƒ£</td>
<td>è®¾ç½®çº¿ç¨‹ä¸Šä¸‹æ–‡ç±»åŠ è½½å™¨ï¼ˆä¸åœ¨è¿™é‡Œï¼Œä½†å¸¸å¸¸åœ¨å¤–å±‚ï¼‰</td>
</tr>
<tr>
<td>5ï¸âƒ£</td>
<td>ç”¨ <code>doPrivileged()</code> ä¿è¯åŠ è½½è¿‡ç¨‹ä¸å—æƒé™é™åˆ¶</td>
</tr>
<tr>
<td>6ï¸âƒ£</td>
<td>å¦‚æœæ‰¾ä¸åˆ°æˆ–æ ¼å¼é”™è¯¯ï¼Œåˆ™æŠ›å‡ºå¼‚å¸¸</td>
</tr>
</tbody></table>
<hr>
<h4>ğŸ”¥ ä¸¾ä¸ªä¾‹å­ï¼ˆå‡è®¾æ˜¯ URLClassLoaderï¼‰</h4>
<p>ä½ ç»™å®ƒä¸€ä¸ªç±»å <code>com.abc.HelloWorld</code>ï¼Œå®ƒä¼šï¼š</p>
<ol>
<li>æŸ¥æ‰¾ <code>/com/abc/HelloWorld.class</code> å¯¹åº”çš„ URLï¼›</li>
<li>è¯»å–å­—èŠ‚ç ï¼›</li>
<li>è½¬æ¢ä¸º <code>Class&lt;?&gt;</code> å¯¹è±¡ï¼›</li>
<li>ç¼“å­˜åˆ°ç±»åŠ è½½å™¨ä¸­ã€‚</li>
</ol>
<hr>
<h3>URLClassLoaderçš„defineClassï¼ˆæŠŠå­—èŠ‚ç å˜æˆ JVM ä¸­çš„ç±»å¯¹è±¡ï¼‰</h3>
<p>ä½ è¿™æ®µä»£ç æ˜¯ Java ç±»åŠ è½½è¿‡ç¨‹ä¸­æœ€ç»ˆâ€œ<strong>æŠŠå­—èŠ‚ç å˜æˆ JVM ä¸­çš„ç±»å¯¹è±¡</strong>â€çš„å®ç°ä¹‹ä¸€ï¼Œä¹Ÿå°±æ˜¯ <code>defineClass(String name, Resource res)</code> æ–¹æ³•çš„è¯¦ç»†è¿‡ç¨‹ã€‚</p>
<p>å®ƒé€šå¸¸å‡ºç°åœ¨ <code>URLClassLoader</code> æˆ–ç±»ä¼¼ç±»åŠ è½½å™¨ä¸­ï¼Œç”¨äºæŠŠ <code>.class</code> æ–‡ä»¶å†…å®¹è¯»å–åï¼Œ<strong>å®šä¹‰æˆ JVM å¯è¯†åˆ«çš„ <code>Class&lt;?&gt;</code> å¯¹è±¡</strong>ã€‚</p>
<p>ä¸‹é¢æˆ‘ä»¬<strong>é€è¡Œè¯¦ç»†æ‹†è§£</strong>å®ƒçš„æ„ä¹‰ï¼š</p>
<hr>
<h4>ğŸ” æ–¹æ³•ç­¾å</h4>
<pre><code class="language-java">private Class&lt;?&gt; defineClass(String name, Resource res) throws IOException
</code></pre>
<ul>
<li><code>name</code>: ç±»çš„å…¨é™å®šåï¼Œæ¯”å¦‚ <code>&quot;com.example.MyClass&quot;</code></li>
<li><code>res</code>: <code>Resource</code> æ˜¯ä¸€ä¸ªå°è£…äº† <code>.class</code> æ–‡ä»¶å­—èŠ‚ç ã€æ¥æº URLã€ç­¾åã€Manifest ç­‰å…ƒæ•°æ®çš„å¯¹è±¡ã€‚</li>
</ul>
<hr>
<h4>â±ï¸ è®°å½•å¼€å§‹æ—¶é—´</h4>
<pre><code class="language-java">long t0 = System.nanoTime();
</code></pre>
<ul>
<li>ç”¨äºç»Ÿè®¡æ€§èƒ½å¼€é”€ï¼ˆåé¢ç”¨ <code>sun.misc.PerfCounter</code> è®°å½•è€—æ—¶ï¼‰ã€‚</li>
</ul>
<hr>
<h4>ğŸ“¦ è·å–åŒ…åå¹¶å°è¯•å®šä¹‰ package</h4>
<pre><code class="language-java">int i = name.lastIndexOf(&#39;.&#39;);
URL url = res.getCodeSourceURL();
if (i != -1) {
    String pkgname = name.substring(0, i);
    Manifest man = res.getManifest();
    definePackageInternal(pkgname, man, url);
}
</code></pre>
<h5>ğŸ§  è¿™éƒ¨åˆ†çš„æ„ä¹‰ï¼š</h5>
<ul>
<li>å¦‚æœç±»æœ‰åŒ…åï¼ˆå³ä¸æ˜¯é»˜è®¤åŒ…ï¼‰ï¼Œå°±æå–åŒ…åã€‚</li>
<li>ä» <code>res</code> è·å– <code>Manifest</code>ï¼ˆé€šå¸¸æ˜¯ jar åŒ…ä¸­çš„ <code>META-INF/MANIFEST.MF</code> æ–‡ä»¶ï¼‰ã€‚</li>
<li>ä½¿ç”¨ <code>definePackageInternal()</code> æ–¹æ³•å®šä¹‰åŒ…ä¿¡æ¯ï¼ˆç‰ˆæœ¬ã€ä½œè€…ã€ç­¾åç­‰ï¼‰ã€‚</li>
<li>å¦‚æœè¯¥åŒ…å·²å­˜åœ¨äº JVMï¼Œåˆ™è·³è¿‡ï¼›å¦åˆ™ä¸ºåŒ…è®¾ç½®ç›¸å…³å…ƒä¿¡æ¯ã€‚</li>
</ul>
<p>è¿™æ ·åšæ˜¯ä¸ºäº†è®©åŒ…çº§åˆ«çš„ä¿¡æ¯ï¼ˆå¦‚ <code>Package.getImplementationVersion()</code>ï¼‰ç”Ÿæ•ˆã€‚</p>
<hr>
<h4>ğŸ“„ è·å–å­—èŠ‚ç æ•°æ®ï¼ˆä¸¤ç§æ–¹å¼ï¼‰</h4>
<pre><code class="language-java">java.nio.ByteBuffer bb = res.getByteBuffer();
if (bb != null) {
    // ä½¿ç”¨ ByteBuffer
    CodeSigner[] signers = res.getCodeSigners();
    CodeSource cs = new CodeSource(url, signers);
    ...
    return defineClass(name, bb, cs);
} else {
    byte[] b = res.getBytes();
    CodeSigner[] signers = res.getCodeSigners();
    CodeSource cs = new CodeSource(url, signers);
    ...
    return defineClass(name, b, 0, b.length, cs);
}
</code></pre>
<h4>ğŸ‘‡ ä¸¤ç§æ–¹å¼åˆ†åˆ«æ˜¯ï¼š</h4>
<table>
<thead>
<tr>
<th>æ–¹å¼</th>
<th>ä¼˜ç‚¹</th>
</tr>
</thead>
<tbody><tr>
<td><code>ByteBuffer</code>ï¼ˆç›´æ¥ç¼“å†²åŒºï¼‰</td>
<td>æ›´é«˜æ•ˆã€é¿å…å¤åˆ¶å¼€é”€ï¼Œå¸¸ç”¨äºå¤§ç±»æˆ– I/O æ˜ å°„</td>
</tr>
<tr>
<td><code>byte[]</code>ï¼ˆæ™®é€šå­—èŠ‚æ•°ç»„ï¼‰</td>
<td>æ›´é€šç”¨ï¼Œå…¼å®¹æ€§æ›´å¼ºï¼Œèµ„æºå°æ—¶å¸¸ç”¨</td>
</tr>
</tbody></table>
<hr>
<h4>ğŸ“„ ä»€ä¹ˆæ˜¯ <code>CodeSource</code>ï¼Ÿ</h4>
<pre><code class="language-java">CodeSource cs = new CodeSource(url, signers);
</code></pre>
<ul>
<li>è¡¨ç¤ºç±»çš„æ¥æºåŠç­¾åä¿¡æ¯ï¼›</li>
<li>JVM åœ¨åŠ è½½ç±»æ—¶ï¼Œä½¿ç”¨è¿™ä¸ªä¿¡æ¯è¿›è¡Œ<strong>å®‰å…¨éªŒè¯ä¸æƒé™æ§åˆ¶</strong>ï¼ˆæ¯”å¦‚ SecurityManagerã€æ²™ç®±æœºåˆ¶ï¼‰ï¼›</li>
<li><code>signers</code> æ˜¯ç±»çš„ç­¾åè€…ï¼ˆå¦‚æœ jar æ˜¯ signed jarï¼‰ã€‚</li>
</ul>
<hr>
<h4>ğŸ’¡ å…³é”®ä¸€æ­¥ï¼šdefineClass</h4>
<pre><code class="language-java">return defineClass(name, bb, cs);
// æˆ–
return defineClass(name, b, 0, b.length, cs);
</code></pre>
<ul>
<li>è¿™æ˜¯ <code>ClassLoader</code> æä¾›çš„æ–¹æ³•ï¼Œæœ€ç»ˆä¼šè°ƒç”¨åº•å±‚ native æ–¹æ³•ï¼ˆ<code>defineClass0</code>ï¼‰å®Œæˆä»¥ä¸‹å·¥ä½œï¼š<ol>
<li>æ ¡éªŒ class æ–‡ä»¶æ ¼å¼æ˜¯å¦åˆæ³•ï¼ˆé­”æ•°ã€ç‰ˆæœ¬ã€å¸¸é‡æ± ç­‰ï¼‰ï¼›</li>
<li>åœ¨ JVM æ–¹æ³•åŒºæˆ–å…ƒç©ºé—´ä¸­æ³¨å†Œç±»å…ƒä¿¡æ¯ï¼›</li>
<li>è¿”å› Java å±‚çš„ <code>Class&lt;?&gt;</code> å¯¹è±¡ã€‚</li>
</ol>
</li>
</ul>
<hr>
<h4>ğŸ“Š æ€§èƒ½è®°å½•</h4>
<pre><code class="language-java">sun.misc.PerfCounter.getReadClassBytesTime().addElapsedTimeFrom(t0);
</code></pre>
<ul>
<li>ç”¨äºè®°å½•<strong>è¯»å–ç±»å­—èŠ‚ç æ‰€èŠ±çš„æ—¶é—´</strong>ï¼Œè¿™æ˜¯ JVM æ€§èƒ½ç›‘æ§çš„ä¸€éƒ¨åˆ†ï¼ˆä¸å½±å“åŠŸèƒ½ï¼Œåªæœ‰ debug æˆ– profiling æ—¶ä¼šç”¨åˆ°ï¼‰ã€‚</li>
</ul>
<hr>
<h4>âœ… æ€»ç»“æ ¸å¿ƒæµç¨‹</h4>
<table>
<thead>
<tr>
<th>æ­¥éª¤</th>
<th>æè¿°</th>
</tr>
</thead>
<tbody><tr>
<td>1ï¸âƒ£</td>
<td>è·å–ç±»çš„åŒ…åï¼Œå¹¶å®šä¹‰åŒ…ï¼ˆå¯é€‰çš„ Manifest ä¿¡æ¯ï¼‰</td>
</tr>
<tr>
<td>2ï¸âƒ£</td>
<td>è·å– <code>.class</code> çš„å­—èŠ‚ç ï¼ˆByteBuffer æˆ– byte[]ï¼‰</td>
</tr>
<tr>
<td>3ï¸âƒ£</td>
<td>æ„é€  CodeSourceï¼ˆæ¥æºå’Œç­¾åä¿¡æ¯ï¼‰</td>
</tr>
<tr>
<td>4ï¸âƒ£</td>
<td>è°ƒç”¨ <code>defineClass()</code> å°†å­—èŠ‚ç è½¬æ¢ä¸º <code>Class&lt;?&gt;</code> å¯¹è±¡</td>
</tr>
<tr>
<td>5ï¸âƒ£</td>
<td>è®°å½•åŠ è½½è€—æ—¶ä¾›æ€§èƒ½åˆ†æ</td>
</tr>
</tbody></table>
<hr>
<h4>ğŸ’¬ å»¶ä¼¸çŸ¥è¯†</h4>
<h5>ğŸš€ defineClass å’Œ defineClass0 åŒºåˆ«</h5>
<ul>
<li><code>defineClass(...)</code> æ˜¯ Java å±‚çš„ APIï¼›</li>
<li>å®ƒæœ€ç»ˆä¼šè°ƒç”¨ native çš„ <code>defineClass0(...)</code>ï¼Œè¿™æ˜¯ JVM å®ç°çš„ä¸€éƒ¨åˆ†ï¼ˆé€šå¸¸ç”¨ C/C++ å®ç°ï¼‰ï¼›</li>
<li>å®ƒæ‰æ˜¯çœŸæ­£æŠŠå­—èŠ‚ç â€œå˜æˆç±»â€çš„åœ°æ–¹ã€‚</li>
</ul>
<hr>
<h4>ğŸ§ª å®æˆ˜ç”¨é€”ï¼ˆä½ å¯ä»¥è¿™æ ·å†™è‡ªå·±çš„ç±»åŠ è½½å™¨ï¼‰</h4>
<pre><code class="language-java">public class MyClassLoader extends ClassLoader {
    @Override
    protected Class&lt;?&gt; findClass(String name) throws ClassNotFoundException {
        byte[] classBytes = ...; // ä»ç£ç›˜/ç½‘ç»œ/åŠ å¯†ä¸­è·å–
        return defineClass(name, classBytes, 0, classBytes.length);
    }
}
</code></pre>
<hr>
<h3>æ€»ç»“ï¼šURLClassLoaderåˆ°åº•åšäº†ä»€ä¹ˆ</h3>
<p>ä½ çš„ç†è§£æ•´ä½“å·²ç»å¾ˆæ¥è¿‘æ ¸å¿ƒï¼Œä¸‹é¢æˆ‘å°†<strong>é€ä¸€éªŒè¯ã€æ¾„æ¸…å’Œè¡¥å……</strong>ä½ çš„ç†è§£ï¼ŒåŒæ—¶è®²æ¸…æ¥š <code>URLClassLoader</code> çš„ä½œç”¨å’Œ <code>defineClass</code> çš„çœŸæ­£å«ä¹‰ã€‚</p>
<hr>
<h2>âœ… ä¸€ã€ä½ å½“å‰çš„ç†è§£éªŒè¯</h2>
<blockquote>
<p><strong>ä½ è¯´ï¼š</strong>â€œè‡ªå®šä¹‰ç±»åŠ è½½å™¨æ‰¾åˆ° parentï¼ˆä¸€èˆ¬æ˜¯ AppClassLoaderï¼‰ï¼Œç„¶å AppClassLoader æ‰¾åˆ° ExtClassLoaderï¼Œæœ€åå§”æ‰˜åˆ° BootstrapClassLoader åŠ è½½ç±»â€</p>
</blockquote>
<p>è¿™æ˜¯ âœ… <strong>åŸºæœ¬æ­£ç¡®çš„</strong>ï¼Œä½†æˆ‘ç¨ä½œè¡¥å……è®©å®ƒæ›´å‡†ç¡®ï¼š</p>
<h3>âœ… æ­£ç¡®ç‰ˆæœ¬åº”æ˜¯ï¼š</h3>
<ol>
<li>è‡ªå®šä¹‰ç±»åŠ è½½å™¨è°ƒç”¨ <code>loadClass(name)</code>ï¼›</li>
<li>å®ƒä¼š <strong>å…ˆå§”æ‰˜ç»™ parentï¼ˆé»˜è®¤ AppClassLoaderï¼‰</strong>ï¼›</li>
<li>AppClassLoader å†å§”æ‰˜ç»™å…¶ parentï¼Œå³ ExtClassLoaderï¼›</li>
<li>ExtClassLoader æœ€ç»ˆå§”æ‰˜ç»™ BootstrapClassLoaderï¼ˆç”¨ <code>null</code> è¡¨ç¤ºï¼‰ï¼›</li>
<li>å¦‚æœæ¯ä¸€å±‚éƒ½åŠ è½½å¤±è´¥ï¼ˆå³æŠ›å‡º <code>ClassNotFoundException</code>ï¼‰ï¼Œ<strong>æ‰å›åˆ°å½“å‰ç±»åŠ è½½å™¨è‡ªå·±çš„ <code>findClass(name)</code> æ¥åŠ è½½</strong>ã€‚</li>
</ol>
<p>è¿™å°±æ˜¯ Java çš„<strong>åŒäº²å§”æ´¾æ¨¡å‹</strong>ï¼ˆParent Delegation Modelï¼‰ï¼š</p>
<blockquote>
<p><strong>â€œæ€»æ˜¯å…ˆå§”æ‰˜çˆ¶åŠ è½½å™¨åŠ è½½ç±»ï¼Œé™¤éçˆ¶åŠ è½½å™¨æ‰¾ä¸åˆ°ï¼Œæ‰ç”±å½“å‰åŠ è½½å™¨å°è¯•åŠ è½½ã€‚â€</strong></p>
</blockquote>
<hr>
<h2>ğŸ” äºŒã€é‚£ <code>URLClassLoader</code> æ˜¯å¹²ä»€ä¹ˆçš„ï¼Ÿ</h2>
<h3>ğŸ‘‰ ç®€ç­”ï¼š</h3>
<p><strong><code>URLClassLoader</code> æ˜¯ä¸€ç§å¯ä»¥ä» URLï¼ˆæ–‡ä»¶ã€jar åŒ…ã€ç½‘ç»œï¼‰åŠ è½½ç±»å’Œèµ„æºçš„ç±»åŠ è½½å™¨ã€‚</strong></p>
<p>å®ƒæ˜¯ JDK æä¾›çš„æœ€å¸¸ç”¨çš„ç±»åŠ è½½å™¨ä¹‹ä¸€ï¼Œç‰¹åˆ«é€‚ç”¨äº <strong>åŠ¨æ€åŠ è½½ jar æ–‡ä»¶</strong>ï¼Œä¾‹å¦‚ï¼š</p>
<pre><code class="language-java">URL[] urls = new URL[] { new URL(&quot;file:/path/to/my-lib.jar&quot;) };
URLClassLoader loader = new URLClassLoader(urls);
Class&lt;?&gt; clazz = loader.loadClass(&quot;com.example.MyClass&quot;);
</code></pre>
<hr>
<h3>ğŸ“¦ å¸¸è§åº”ç”¨åœºæ™¯ï¼š</h3>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>Java åº”ç”¨æœåŠ¡å™¨ï¼ˆå¦‚ Tomcatï¼‰</td>
<td>ä¸ºæ¯ä¸ª Web åº”ç”¨åˆ†é…ä¸åŒçš„ <code>URLClassLoader</code></td>
</tr>
<tr>
<td>æ’ä»¶ç³»ç»Ÿ</td>
<td>åŠ¨æ€åŠ è½½ç¬¬ä¸‰æ–¹ jar åŒ…</td>
</tr>
<tr>
<td>è¿è¡Œæ—¶æ‰©å±•</td>
<td>è„šæœ¬å¼•æ“ã€ç¼–è¯‘å™¨ã€çƒ­æ›´æ–°ã€Java SPI</td>
</tr>
</tbody></table>
<hr>
<h2>ğŸ§  ä¸‰ã€çœŸæ­£åŠ è½½ç±»çš„æ˜¯ä¸æ˜¯ <code>defineClass()</code>ï¼Ÿ</h2>
<h3>âœ… æ˜¯çš„ï¼Œä½†æ³¨æ„åŒºåˆ†ä¸¤ç§æ–¹æ³•ï¼š</h3>
<h4>ğŸš© <code>loadClass(name)</code>ï¼ˆåœ¨ <code>ClassLoader</code> ä¸­ï¼‰</h4>
<ul>
<li>æ˜¯å¤–éƒ¨è°ƒç”¨å…¥å£ï¼ˆæ¯”å¦‚ <code>Class.forName(...)</code> ä¹Ÿæ˜¯ç”¨å®ƒï¼‰ï¼›</li>
<li>å®ƒéµå¾ª <strong>åŒäº²å§”æ´¾æ¨¡å‹</strong>ï¼Œä¼šå…ˆå§”æ‰˜ç»™ <code>parent.loadClass(...)</code>ï¼›</li>
<li>å¦‚æœçˆ¶åŠ è½½å™¨éƒ½æ²¡æ‰¾åˆ°ï¼Œå†è°ƒç”¨ <code>findClass(name)</code>ã€‚</li>
</ul>
<h4>ğŸš© <code>findClass(name)</code>ï¼ˆä½ è‡ªå·±å®ç°çš„ï¼‰</h4>
<ul>
<li>å¦‚æœçˆ¶åŠ è½½å™¨å¤±è´¥ï¼Œå°±èµ°åˆ°è¿™é‡Œï¼›</li>
<li>åœ¨è¿™é‡Œï¼Œä½ å¯ä»¥ä½¿ç”¨ <code>defineClass(...)</code> æŠŠäºŒè¿›åˆ¶å­—èŠ‚ç è½¬æ¢æˆ JVM è¯†åˆ«çš„ <code>Class&lt;?&gt;</code>ã€‚</li>
</ul>
<h4>ğŸš© <code>defineClass(...)</code>ï¼ˆæœ€ç»ˆå®ç°åŠ è½½çš„æ ¸å¿ƒæ–¹æ³•ï¼‰</h4>
<ul>
<li>å®ƒæ˜¯ JVM æä¾›çš„ native æ–¹æ³•ï¼ŒçœŸæ­£å®Œæˆï¼š<ol>
<li><strong>éªŒè¯</strong>ï¼šæ ¡éªŒ class æ–‡ä»¶æ ¼å¼ï¼›</li>
<li><strong>å‡†å¤‡</strong>ï¼šä¸ºç±»åˆ†é…å†…å­˜ã€ç”Ÿæˆæ–¹æ³•è¡¨ã€å­—æ®µè¡¨ï¼›</li>
<li><strong>è¿æ¥</strong>ï¼šè§£æä¾èµ–ã€å‡†å¤‡é™æ€å˜é‡ï¼›</li>
<li><strong>è¿”å›</strong>ï¼š<code>Class&lt;?&gt;</code> å¯¹è±¡ã€‚</li>
</ol>
</li>
</ul>
<hr>
<h3>ğŸ“˜ æ€»ç»“ï¼šURLClassLoader ä¸ç±»åŠ è½½æµç¨‹çš„å…³ç³»å›¾</h3>
<pre><code>        ClassLoader.loadClass(name)
               â†“
   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€åŒäº²å§”æ´¾â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
   â†“                           â†“
è‡ªå®šä¹‰ç±»åŠ è½½å™¨              parent.loadClass(name)
     â†“                          â†“
findClass(name)         ExtClassLoader â†’ BootstrapClassLoader
     â†“
è¯»å–URLä¸­çš„classæ–‡ä»¶
     â†“
defineClass(name, bytes, ...)
     â†“
è¿”å›Classå¯¹è±¡
</code></pre>
<hr>
<h3>âœ… å…³é”®è¦ç‚¹æ€»ç»“</h3>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>ç­”æ¡ˆ</th>
</tr>
</thead>
<tbody><tr>
<td><code>URLClassLoader</code> ä½œç”¨æ˜¯ä»€ä¹ˆï¼Ÿ</td>
<td>å¯ä»¥ä»æœ¬åœ°æˆ–ç½‘ç»œçš„ URLï¼ˆç›®å½•ã€jar åŒ…ï¼‰ä¸­åŠ è½½ç±»å’Œèµ„æºã€‚</td>
</tr>
<tr>
<td>å®ƒæ˜¯å¦ä½¿ç”¨åŒäº²å§”æ´¾æ¨¡å‹ï¼Ÿ</td>
<td>æ˜¯çš„ï¼Œå®ƒç»§æ‰¿è‡ª <code>ClassLoader</code>ï¼Œéµå¾ªåŒäº²å§”æ´¾æ¨¡å‹ã€‚</td>
</tr>
<tr>
<td><code>defineClass</code> æ˜¯ä»€ä¹ˆæ—¶å€™è°ƒç”¨çš„ï¼Ÿ</td>
<td>å½“ <code>loadClass</code> ä¸­çˆ¶ç±»åŠ è½½å¤±è´¥åï¼Œè°ƒç”¨ <code>findClass()</code>ï¼Œä½ æ‰ä¼šè°ƒç”¨ <code>defineClass()</code> æ¥çœŸæ­£åŠ è½½å­—èŠ‚ç ã€‚</td>
</tr>
<tr>
<td>æ˜¯å¦æ‰€æœ‰ç±»éƒ½èµ°åˆ° <code>defineClass()</code>ï¼Ÿ</td>
<td>å¦ï¼Œåªæœ‰çˆ¶åŠ è½½å™¨åŠ è½½å¤±è´¥æ—¶æ‰ä¼šèµ°åˆ°ä½ è‡ªå®šä¹‰çš„ <code>findClass()</code>ï¼Œè¿›è€Œè°ƒç”¨ <code>defineClass()</code>ã€‚</td>
</tr>
</tbody></table>
<hr>
<h3>âœ… ç®€ç­”ï¼šä»€ä¹ˆæ—¶å€™ä¼šç”¨åˆ° <code>URLClassLoader</code>ï¼Ÿ</h3>
<p><strong><code>URLClassLoader</code> æ˜¯åœ¨ä½ éœ€è¦</strong> <em>â€œä»æŒ‡å®šè·¯å¾„æˆ– jar åŒ…ä¸­åŠ¨æ€åŠ è½½ç±»â€</em> çš„æ—¶å€™æ‰ä¼šè¢«ä¸»åŠ¨åˆ›å»ºå’Œè°ƒç”¨ã€‚</p>
<h4>ğŸ” å¸¸è§ä½¿ç”¨åœºæ™¯</h4>
<table>
<thead>
<tr>
<th>åœºæ™¯</th>
<th>æ˜¯å¦é»˜è®¤è°ƒç”¨</th>
</tr>
</thead>
<tbody><tr>
<td><strong>Java å‘½ä»¤è¡Œè¿è¡Œåº”ç”¨ï¼ˆjava xxxï¼‰</strong></td>
<td>âœ… JVM é»˜è®¤ç”¨ <code>AppClassLoader</code>ï¼Œå°±æ˜¯ä¸€ä¸ª <code>URLClassLoader</code></td>
</tr>
<tr>
<td><strong>ç±»è·¯å¾„ä¸‹ jar åŠ è½½</strong></td>
<td>âœ… é»˜è®¤èµ° <code>URLClassLoader</code></td>
</tr>
<tr>
<td><strong>è‡ªå®šä¹‰åŠ è½½ jar æ’ä»¶</strong></td>
<td>âœ… ä½ æ‰‹åŠ¨ new å‡º <code>URLClassLoader</code></td>
</tr>
<tr>
<td><strong>Tomcat/WebæœåŠ¡å™¨</strong></td>
<td>âœ… ä¸ºæ¯ä¸ª Web åº”ç”¨åˆ›å»ºç‹¬ç«‹çš„ <code>URLClassLoader</code></td>
</tr>
<tr>
<td><strong>IDEï¼ˆå¦‚ IntelliJï¼‰è¿è¡Œ Java ç¨‹åº</strong></td>
<td>âœ… ä½¿ç”¨ <code>AppClassLoader</code>ï¼Œæœ¬è´¨å°±æ˜¯ <code>URLClassLoader</code></td>
</tr>
<tr>
<td><strong>Java SPI</strong></td>
<td>âœ… <code>ServiceLoader</code> é»˜è®¤ä½¿ç”¨ <code>Thread.currentThread().getContextClassLoader()</code>ï¼Œå¾€å¾€æ˜¯ <code>URLClassLoader</code></td>
</tr>
</tbody></table>
<h3>âœ… JVM å¯åŠ¨æ—¶çš„å®é™…ç±»åŠ è½½å™¨é“¾</h3>
<pre><code class="language-java">public class LoaderTest {
    public static void main(String[] args) {
        ClassLoader cl = LoaderTest.class.getClassLoader();
        System.out.println(&quot;ClassLoader: &quot; + cl);
        System.out.println(&quot;Parent: &quot; + cl.getParent());
        System.out.println(&quot;Grandparent: &quot; + cl.getParent().getParent());
    }
}
</code></pre>
<p>è¾“å‡ºç±»ä¼¼ï¼š</p>
<pre><code>ClassLoader: sun.misc.Launcher$AppClassLoader@...
Parent: sun.misc.Launcher$ExtClassLoader@...
Grandparent: null
</code></pre>
<p>è€Œ <code>AppClassLoader</code> å°±æ˜¯ <code>URLClassLoader</code> çš„å­ç±»ã€‚</p>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>å›ç­”</th>
</tr>
</thead>
<tbody><tr>
<td>ğŸ“Œ URLClassLoader æ˜¯ä»€ä¹ˆæ—¶å€™ç”¨åˆ°çš„ï¼Ÿ</td>
<td>JVM å¯åŠ¨æ—¶ä½œä¸º <code>AppClassLoader</code> åŠ è½½ç±»è·¯å¾„ä¸‹çš„æ‰€æœ‰ç±»ï¼›ä¹Ÿå¸¸ç”¨äºæ‰‹åŠ¨åŠ è½½ jarã€åŠ¨æ€æ’ä»¶ã€SPI ç­‰ã€‚</td>
</tr>
<tr>
<td>ğŸ“Œ æºç ä¸­å“ªé‡Œå¯ä»¥æ‰¾åˆ° URLClassLoader çš„ä½¿ç”¨ï¼Ÿ</td>
<td>è§ <code>sun.misc.Launcher$AppClassLoader</code>ã€<code>ClassLoader.getSystemClassLoader()</code>ï¼Œå®é™…å°±æ˜¯ URLClassLoaderã€‚</td>
</tr>
<tr>
<td>ğŸ“Œ ä¸ºä»€ä¹ˆä½ æ²¡åœ¨æ ¸å¿ƒé€»è¾‘é‡Œç›´æ¥çœ‹åˆ°å®ƒï¼Ÿ</td>
<td>å› ä¸º JVM å¯åŠ¨æ—¶é€šè¿‡ <code>sun.misc.Launcher</code> åˆ›å»ºï¼Œéæ ‡å‡†å…¬å¼€ APIï¼Œæ‰€ä»¥éšè—åœ¨å†…éƒ¨å®ç°ã€‚</td>
</tr>
<tr>
<td>ğŸ“Œ å®ƒæ˜¯å¦é»˜è®¤å­˜åœ¨ï¼Ÿ</td>
<td>æ˜¯çš„ï¼ä½ è¿è¡Œ Java åº”ç”¨æ—¶é»˜è®¤å°±ä½¿ç”¨äº† URLClassLoaderã€‚</td>
</tr>
</tbody></table>
<h2>é—®é¢˜ï¼šè¯•å›¾ç”¨è‡ªå®šä¹‰ç±»åŠ è½½å™¨åŠ è½½JDKçš„åŸºç¡€ç±»</h2>
<p>ç°åœ¨é‡åˆ°çš„è¿™ä¸ªé”™è¯¯ï¼š</p>
<pre><code>java.lang.NoClassDefFoundError: java/lang/Object
</code></pre>
<p>æ„å‘³ç€ä½ çš„è‡ªå®šä¹‰ç±»åŠ è½½å™¨ <code>MyClassLoader</code> è¯•å›¾åŠ è½½ JDK çš„åŸºç¡€ç±» <code>java.lang.Object</code>ï¼Œè€Œ <strong>æ ¹æœ¬å°±ä¸è¯¥ç”±ä½ è¿™ä¸ªç±»åŠ è½½å™¨å»åŠ è½½</strong>ã€‚</p>
<p>ä¸€èˆ¬æ¥è¯´ä½¿ç”¨åŒäº²å§”æ´¾ï¼ŒåªåŠ è½½ä½ éœ€è¦çš„ç±»</p>
<p>ä½ å¯ä»¥è¿›ä¸€æ­¥é™åˆ¶ä½ çš„ç±»åŠ è½½å™¨åªå¤„ç†æŸäº›ç‰¹å®šåŒ…ï¼Œæ¯”å¦‚ï¼š</p>
<pre><code class="language-java">if (!name.startsWith(&quot;tech.insight&quot;)) {
    return super.loadClass(name, resolve); // ç”¨çˆ¶ç±»åŠ è½½
}
</code></pre>
<p>æ¯”å¦‚ï¼š</p>
<pre><code>@Override
protected Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException {
    synchronized (getClassLoadingLock(name)) {
        Class&lt;?&gt; c = findLoadedClass(name);
        if (c == null) {
            // æ‰“ç ´åŒäº²å§”æ´¾ï¼ŒåªåŠ è½½ tech.insight åŒ…ä¸‹çš„ç±»
            if (name.startsWith(&quot;tech.insight&quot;)) {
                try {
                    c = findClass(name);
                } catch (ClassNotFoundException e) {
                    // å¯ä»¥é€‰æ‹©ä¸å¤„ç†æˆ– fallback ç»™çˆ¶åŠ è½½å™¨
                    throw e;
                }
            } else {
                // JDKç±»æˆ–ç¬¬ä¸‰æ–¹åº“ä¾ç„¶å§”æ‰˜çˆ¶åŠ è½½å™¨
                c = getParent().loadClass(name);
            }
        }

        if (resolve) {
            resolveClass(c);
        }

        return c;
    }
}
</code></pre>
<p>è®°ä½è¿™å’Œ-Djava.system.class.loader=tech.insight.MyClassLoaderç›´æ¥é…ç½®åˆ°è™šæ‹Ÿæœºå‚æ•°æœ‰åŒºåˆ«ã€‚</p>
<h2>è‡ªå®šä¹‰ç±»åŠ è½½å™¨å’ŒJVMå‚æ•°è®¾ç½®æœ‰åŒºåˆ«</h2>
<p>è¿™æ˜¯ä¸ªéå¸¸æ ¸å¿ƒçš„é—®é¢˜ï¼Œ<strong>è‡ªå®šä¹‰ç±»åŠ è½½å™¨</strong>å’Œ <code>-Djava.system.class.loader=...</code> æŒ‡å®š<strong>ç³»ç»Ÿç±»åŠ è½½å™¨</strong>ï¼Œå®ƒä»¬ä¹‹é—´åœ¨ JVM åˆå§‹åŒ–é˜¶æ®µçš„è¡Œä¸ºã€æƒé™ã€å½±å“èŒƒå›´ä¸Šæœ‰æœ¬è´¨åŒºåˆ«ã€‚</p>
<hr>
<h3>âœ… ç®€å•åŒºåˆ«è¡¨</h3>
<table>
<thead>
<tr>
<th>é¡¹ç›®</th>
<th><code>new MyClassLoader()</code></th>
<th><code>-Djava.system.class.loader=tech.insight.MyClassLoader</code></th>
</tr>
</thead>
<tbody><tr>
<td>åŠ è½½æ—¶æœº</td>
<td>ç¨‹åºè¿è¡Œæ—¶ç”±ä½ æ‰‹åŠ¨å®ä¾‹åŒ–</td>
<td>JVM å¯åŠ¨æ—¶åˆå§‹åŒ–ï¼Œæ›¿æ¢æ•´ä¸ª SystemClassLoader</td>
</tr>
<tr>
<td>å½±å“èŒƒå›´</td>
<td>åªå½±å“ä½ æ‰‹åŠ¨ä½¿ç”¨å®ƒåŠ è½½çš„ç±»</td>
<td>å½±å“æ‰€æœ‰é€šè¿‡ <code>ClassLoader.getSystemClassLoader()</code> çš„ç±»åŠ è½½</td>
</tr>
<tr>
<td>åŠ è½½ä¼˜å…ˆçº§</td>
<td>ä¸ä¼šå½±å“å…¶ä»–ç±»çš„åŠ è½½</td>
<td>ä¼šå‚ä¸ JVM è‡ªèº«çš„ç±»åŠ è½½æµç¨‹ï¼Œä¼˜å…ˆäºé»˜è®¤ AppClassLoader</td>
</tr>
<tr>
<td>å®‰å…¨é™åˆ¶</td>
<td>é™äºåº”ç”¨ä»£ç èŒƒå›´</td>
<td>JVM è¦æ±‚å¿…é¡»æœ‰åˆæ³•æ„é€ å‡½æ•°ï¼š<code>MyClassLoader(ClassLoader parent)</code></td>
</tr>
<tr>
<td>å®¹é”™é£é™©</td>
<td>å®‰å…¨ï¼Œä¸å½±å“ JVM å¯åŠ¨</td>
<td>ä¸€æ—¦å‡ºé”™ï¼ˆå¦‚æ„é€ å‡½æ•°ä¸å¯¹ï¼‰ï¼ŒJVM å¯åŠ¨ç›´æ¥å¤±è´¥ï¼ˆä½ å°±è§è¿‡äº†ï¼‰</td>
</tr>
</tbody></table>
<hr>
<h3>âœ… <code>-Djava.system.class.loader=...</code> æ˜¯ä»€ä¹ˆï¼Ÿ</h3>
<p>JVM å¯åŠ¨æ—¶ï¼Œä¼šåŠ è½½ä¸€ä¸ª<strong>ç³»ç»Ÿç±»åŠ è½½å™¨ï¼ˆSystemClassLoaderï¼‰</strong>ï¼Œé»˜è®¤æ˜¯ï¼š</p>
<pre><code>sun.misc.Launcher$AppClassLoader
</code></pre>
<p>ä½ å¯ä»¥é€šè¿‡ JVM å‚æ•°æ‰‹åŠ¨æ›¿æ¢è¿™ä¸ªåŠ è½½å™¨ï¼Œæ¯”å¦‚ï¼š</p>
<pre><code class="language-bash">java -Djava.system.class.loader=tech.insight.MyClassLoader ...
</code></pre>
<p>è¿™ä¼šè®© JVM åœ¨åˆå§‹åŒ–æ—¶ï¼š</p>
<pre><code class="language-java">ClassLoader scl = (ClassLoader) Class.forName(&quot;tech.insight.MyClassLoader&quot;)
    .getDeclaredConstructor(ClassLoader.class)
    .newInstance(parentLoader);
</code></pre>
<p>è¿™å°±æ˜¯ä½ çœ‹åˆ°çš„æŠ¥é”™çš„æ¥æºï¼š</p>
<pre><code>NoSuchMethodException: tech.insight.MyClassLoader.&lt;init&gt;(java.lang.ClassLoader)
</code></pre>
<hr>
<h3>âœ… ä½¿ç”¨è¯¥å‚æ•°æ—¶è¦æ»¡è¶³çš„æ¡ä»¶</h3>
<ol>
<li>ç±»å¿…é¡»èƒ½è¢« Bootstrap æˆ– Extension ç±»åŠ è½½å™¨åŠ è½½ï¼ˆé€šå¸¸è¦æ±‚è¯¥ç±»åœ¨ <code>classpath</code> ä¸­ï¼‰ï¼›</li>
<li>å¿…é¡»å®šä¹‰å¦‚ä¸‹æ„é€ å‡½æ•°ï¼š</li>
</ol>
<pre><code class="language-java">public MyClassLoader(ClassLoader parent) {
    super(parent);
}
</code></pre>
<ol>
<li>å¿…é¡»ä¸èƒ½æŠ›å‡ºå¼‚å¸¸ï¼Œå‡ºé”™ JVM å°±å¯åŠ¨å¤±è´¥ï¼›</li>
</ol>
<hr>
<h3>âœ… ä»€ä¹ˆæ—¶å€™ç”¨ <code>-Djava.system.class.loader</code> æ›´åˆé€‚ï¼Ÿ</h3>
<p>é€‚ç”¨äºï¼š</p>
<ul>
<li>æƒ³è¦<strong>æ‹¦æˆª/æ§åˆ¶æ‰€æœ‰ç±»åŠ è½½</strong>è¡Œä¸ºï¼Œæ¯”å¦‚å®ç°å®‰å…¨éš”ç¦»ã€åŠ å¯† class æ–‡ä»¶ã€åŠ¨æ€ patchï¼›</li>
<li>æƒ³å†™ç±»ä¼¼ Java Agentã€Sandboxã€æ’ä»¶å®¹å™¨ç­‰åº•å±‚æ¡†æ¶ï¼›</li>
<li>æƒ³æ¥ç®¡ <code>Class.forName()</code>ã€SPIã€<code>Thread.getContextClassLoader()</code> è¡Œä¸ºçš„åœºæ™¯ï¼›</li>
</ul>
<hr>
<h3>âœ… ç›¸å¯¹åœ°ï¼Œæ‰‹åŠ¨ new æ›´å®‰å…¨çµæ´»</h3>
<p>ä½ ç”¨ï¼š</p>
<pre><code class="language-java">MyClassLoader cl = new MyClassLoader();
cl.loadClass(...);
</code></pre>
<p>ä¼˜ç‚¹ï¼š</p>
<ul>
<li>ä¸å½±å“å…¶ä»–ç±»çš„åŠ è½½ï¼›</li>
<li>å®¹é”™æ€§å¼ºï¼›</li>
<li>å¯æ§ç²’åº¦ç»†ï¼›</li>
</ul>
<p>ç¼ºç‚¹ï¼š</p>
<ul>
<li>ä¸ä¼šå½±å“ <code>Class.forName</code>ã€åå°„åŠ è½½ã€SPI ç­‰è¡Œä¸ºï¼›</li>
<li>éœ€è¦æ‰‹åŠ¨åŠ è½½ç±»å¹¶è°ƒç”¨ï¼ˆåƒ pluginLoader çš„å½¢å¼ï¼‰ï¼›</li>
</ul>
<hr>
<h3>âœ… æ€»ç»“ç±»æ¯”</h3>
<table>
<thead>
<tr>
<th>ç±»æ¯”</th>
<th>æ„æ€</th>
</tr>
</thead>
<tbody><tr>
<td><code>new MyClassLoader()</code></td>
<td>å°±åƒä½ å†™äº†ä¸ªå·¥å…·ç±»ï¼Œä¸“é—¨å¹²è‡ªå·±äº‹</td>
</tr>
<tr>
<td><code>-Djava.system.class.loader=...</code></td>
<td>åƒä½ <strong>æ¢äº†æ•´ä¸ªæ“ä½œç³»ç»Ÿçš„ class åŠ è½½æœºåˆ¶</strong></td>
</tr>
</tbody></table>
<hr>
<h3>âœ… å®æˆ˜å»ºè®®</h3>
<ul>
<li>æƒ³ç ”ç©¶ç±»åŠ è½½æœºåˆ¶ã€åšæ’ä»¶éš”ç¦»ï¼šå…ˆç”¨ <code>new MyClassLoader()</code> å®‰å…¨ç»ƒæ‰‹ï¼›</li>
<li>æƒ³ hook æ•´ä¸ªåº”ç”¨åŠ è½½æµç¨‹æˆ–åŠ å¯†ä¿æŠ¤ class æ–‡ä»¶ï¼Œå†è€ƒè™‘ <code>-Djava.system.class.loader</code>ï¼›</li>
<li><strong>ç»ä¸è¦ç›²ç›®æ›¿æ¢ç³»ç»Ÿç±»åŠ è½½å™¨</strong>ï¼Œé™¤éä½ <strong>100%çŸ¥é“ä½ åœ¨å¹²ä»€ä¹ˆ</strong>ã€‚</li>
</ul>
<hr>
<p>éœ€è¦æˆ‘å†™ä¸€ä¸ª <code>-Djava.system.class.loader</code> çš„å®Œæ•´ä¾‹å­ï¼ŒåŒ…å«å¯åŠ¨è„šæœ¬ã€æ„é€ å™¨å®ç°ã€ç¤ºä¾‹ç±»åŠ è½½è¡Œä¸ºå¯¹æ¯”å—ï¼Ÿ</p>
<h2>é—®é¢˜ï¼šè®¾ç½®JVMå‚æ•°æŒ‡å®šç³»ç»Ÿç±»åŠ è½½å™¨æ²¡ç”Ÿæ•ˆ</h2>
<p>åœ¨ IDEA ä¸­è®¾ç½® <code>-Djava.system.class.loader=tech.insight.MyClassLoader</code> æ²¡ç”Ÿæ•ˆï¼Œå¯èƒ½æ˜¯ç”±äº <strong>ç³»ç»Ÿç±»åŠ è½½å™¨è®¾ç½®æœ‰ä¸¥æ ¼çš„æ—¶æœºè¦æ±‚å’Œç±»è·¯å¾„é™åˆ¶</strong>ã€‚ä»¥ä¸‹æ˜¯å¸¸è§åŸå› å’Œè§£å†³æ–¹æ³•ï¼š</p>
<hr>
<h3>âœ… æ­£ç¡®è®¾ç½®çš„å‰æ</h3>
<h4>1. <strong>è®¾ç½®ä½ç½®</strong></h4>
<p>å¿…é¡»åœ¨ <strong>JVM å¯åŠ¨å‚æ•°</strong>ä¸­è®¾ç½®ï¼Œè€Œä¸æ˜¯ç¨‹åºè¿è¡Œæ—¶åŠ¨æ€è®¾ç½®ã€‚</p>
<h5>IDEA è®¾ç½®æ–¹å¼ï¼š</h5>
<p>æ‰“å¼€ <code>Run | Edit Configurations</code>ï¼Œåœ¨ VM options ä¸­åŠ å…¥ï¼š</p>
<pre><code class="language-bash">-Djava.system.class.loader=tech.insight.MyClassLoader
</code></pre>
<hr>
<h4>2. <strong>ä½ çš„ ClassLoader å¿…é¡»èƒ½è¢« Bootstrap ClassLoader åŠ è½½</strong></h4>
<p>ç³»ç»Ÿç±»åŠ è½½å™¨çš„æ›¿ä»£ç±»ï¼ˆä½ çš„ <code>tech.insight.MyClassLoader</code>ï¼‰<strong>å¿…é¡»åœ¨ bootstrap classpath æˆ– extension classpath ä¸­</strong>ï¼Œå¦åˆ™ JVM æ ¹æœ¬åŠ è½½ä¸åˆ°ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼š<code>MyClassLoader</code> <strong>ä¸èƒ½é€šè¿‡ AppClassLoader åŠ è½½è‡ªå·±</strong>ï¼Œå¦åˆ™å°±é™·å…¥æ­»å¾ªç¯ã€‚</p>
<h5>è§£å†³æ–¹æ¡ˆï¼š</h5>
<p>å°† <code>MyClassLoader</code> æ‰€åœ¨çš„ jar æ”¾åˆ°å¯åŠ¨ç±»è·¯å¾„é‡Œï¼š</p>
<h5>æ–¹æ³•ä¸€ï¼šä½¿ç”¨ <code>-Xbootclasspath/a</code> ï¼ˆJava 8 åŠä»¥å‰ï¼‰</h5>
<pre><code class="language-bash">-Xbootclasspath/a:/path/to/myclassloader.jar
</code></pre>
<h5>æ–¹æ³•äºŒï¼šJava 9+ ä½¿ç”¨æ¨¡å—æ–¹å¼å¯åŠ¨ï¼Œå¿…é¡»åŠ  <code>--patch-module</code> æˆ–å…¶ä»–æ–¹å¼æ³¨å…¥ã€‚</h5>
<hr>
<h4>3. <strong>ä½ çš„ç±»åŠ è½½å™¨å¿…é¡»æœ‰ä¸€ä¸ªæ ‡å‡†çš„æ„é€ å‡½æ•°</strong></h4>
<p>ç³»ç»Ÿä¼šç”¨åå°„è°ƒç”¨å¦‚ä¸‹æ„é€ æ–¹æ³•ï¼š</p>
<pre><code class="language-java">public MyClassLoader(ClassLoader parent)
</code></pre>
<p>ä½ å¿…é¡»æä¾›è¿™ä¸ªæ„é€ å‡½æ•°ã€‚</p>
<hr>
<h4>4. <strong>ç¡®ä¿ä¸»ç±»ä¸åœ¨è¢«ä½ åŠ è½½çš„èŒƒå›´å†…</strong></h4>
<p>å¦‚æœä½ è‡ªå·±åŠ è½½äº†ä¸»ç±»ï¼Œæœ‰å¯èƒ½é€ æˆç±»åŠ è½½å†²çªæˆ–åŒé‡åŠ è½½ï¼ˆç±»åŠ è½½å™¨éš”ç¦»ï¼‰ã€‚</p>
<hr>
<h4>5. <strong>æœ‰äº› IDE è¡Œä¸ºä¸åŒäºç›´æ¥å‘½ä»¤è¡Œ</strong></h4>
<p>IDEA åœ¨è°ƒè¯•/è¿è¡Œé…ç½®ä¸­ï¼Œå¯èƒ½ä¼šé¢å¤–æ’å…¥è‡ªå·±çš„ç±»åŠ è½½é€»è¾‘ï¼Œå¯¼è‡´ <code>-Djava.system.class.loader</code> è¢«ç»•è¿‡æˆ–å¹²æ‰°ã€‚</p>
<hr>
<h3>âœ… ç¤ºä¾‹</h3>
<p>æ¯”å¦‚ä½ æœ‰ä¸ªè‡ªå®šä¹‰ç±»åŠ è½½å™¨ï¼š</p>
<pre><code class="language-java">package tech.insight;

public class MyClassLoader extends ClassLoader {
    public MyClassLoader(ClassLoader parent) {
        super(parent);
        System.out.println(&quot;MyClassLoader initialized&quot;);
    }

    @Override
    protected Class&lt;?&gt; loadClass(String name, boolean resolve) throws ClassNotFoundException {
        // åŠ è½½é€»è¾‘ ...
        return super.loadClass(name, resolve);
    }
}
</code></pre>
<p>ä½ éœ€è¦ï¼š</p>
<ol>
<li>ç¼–è¯‘å¹¶æ‰“åŒ…æˆ JARï¼›</li>
<li>ä½¿ç”¨å¦‚ä¸‹ JVM å‚æ•°ï¼š</li>
</ol>
<pre><code class="language-bash">-Djava.system.class.loader=tech.insight.MyClassLoader -Xbootclasspath/a:/path/to/myclassloader.jar
</code></pre>
<hr>
<h3>âœ… éªŒè¯æ˜¯å¦ç”Ÿæ•ˆ</h3>
<p>ä½ å¯ä»¥åœ¨ <code>MyClassLoader</code> æ„é€ å‡½æ•°ä¸­åŠ ä¸€æ¡æ—¥å¿—ï¼Œæˆ–è€…æ‰“å°å½“å‰ç±»åŠ è½½å™¨ï¼š</p>
<pre><code class="language-java">System.out.println(&quot;SystemClassLoader: &quot; + ClassLoader.getSystemClassLoader());
</code></pre>
<p>å¦‚æœä¸æ˜¯ä½ çš„ç±»ï¼Œåˆ™è¯´æ˜è®¾ç½®å¤±è´¥ã€‚</p>
<hr>
<h3>ğŸ” æ€»ç»“æ’æŸ¥ checklistï¼š</h3>
<table>
<thead>
<tr>
<th>æ£€æŸ¥é¡¹</th>
<th>æ˜¯å¦æ­£ç¡®</th>
</tr>
</thead>
<tbody><tr>
<td>JVM å‚æ•° <code>-Djava.system.class.loader</code> è®¾ç½®åœ¨ VM options ä¸­</td>
<td>âœ…</td>
</tr>
<tr>
<td>è‡ªå®šä¹‰ç±»åŠ è½½å™¨æ‰“åŒ…å¹¶é€šè¿‡ <code>-Xbootclasspath/a</code> åŠ å…¥å¯åŠ¨ç±»è·¯å¾„</td>
<td>âœ…</td>
</tr>
<tr>
<td><code>MyClassLoader</code> æœ‰ <code>(ClassLoader parent)</code> æ„é€ å‡½æ•°</td>
<td>âœ…</td>
</tr>
<tr>
<td>IDEA æ²¡æœ‰ä¿®æ”¹ç±»è·¯å¾„æˆ–ç±»åŠ è½½å™¨ï¼ˆå¯ä»¥å°è¯•å‘½ä»¤è¡Œè¿è¡ŒéªŒè¯ï¼‰</td>
<td>âœ…</td>
</tr>
</tbody></table>
<hr>
<h2>ä»€ä¹ˆå«nativeå‡½æ•°</h2>
<p><code>native</code> å‡½æ•°æ˜¯ Java ä¸­çš„ä¸€ç§<strong>æœ¬åœ°æ–¹æ³•ï¼ˆNative Methodï¼‰</strong>ï¼ŒæŒ‡çš„æ˜¯ï¼š</p>
<blockquote>
<p>ä½¿ç”¨ Java è¯­è¨€å£°æ˜ã€ä½†åœ¨ <strong>é Java è¯­è¨€ï¼ˆé€šå¸¸æ˜¯ C æˆ– C++ï¼‰ä¸­å®ç°</strong> çš„æ–¹æ³•ã€‚</p>
</blockquote>
<hr>
<h3>ğŸ§  ä¸ºä»€ä¹ˆè¦ç”¨ <code>native</code> æ–¹æ³•ï¼Ÿ</h3>
<p>Java è™šæ‹Ÿæœºï¼ˆJVMï¼‰è™½ç„¶å¹³å°æ— å…³ï¼Œä½†æœ‰äº›åº•å±‚æ“ä½œå¿…é¡»ä¾èµ–æ“ä½œç³»ç»Ÿæˆ–æœ¬åœ°ç¡¬ä»¶ï¼Œæ¯”å¦‚ï¼š</p>
<table>
<thead>
<tr>
<th>åŠŸèƒ½</th>
<th>ä¾èµ– native æ–¹æ³•</th>
</tr>
</thead>
<tbody><tr>
<td>æ“ä½œç³»ç»Ÿè°ƒç”¨ï¼ˆå¦‚æ–‡ä»¶ã€ç½‘ç»œã€çº¿ç¨‹ï¼‰</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>ç³»ç»Ÿæ—¶é—´ã€å¯¹è±¡å†…å­˜å¸ƒå±€</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>å’Œ C/C++ å…±äº«å†…å­˜æˆ–è°ƒç”¨ DLL</td>
<td>æ˜¯</td>
</tr>
<tr>
<td>è°ƒç”¨ç¬¬ä¸‰æ–¹æœ¬åœ°åº“ï¼ˆå¦‚ OpenCVã€FFmpegï¼‰</td>
<td>æ˜¯</td>
</tr>
</tbody></table>
<hr>
<h3>âœ… è¯­æ³•ç¤ºä¾‹</h3>
<p>åœ¨ Java ä¸­å£°æ˜ä¸€ä¸ª native æ–¹æ³•ï¼š</p>
<pre><code class="language-java">public class NativeExample {
    // native æ–¹æ³•å£°æ˜
    public native void sayHello();

    static {
        // åŠ è½½æœ¬åœ°åº“ï¼Œæ¯”å¦‚ libnative.so / native.dll
        System.loadLibrary(&quot;native&quot;);
    }
}
</code></pre>
<p>ç„¶åä½ éœ€è¦ç”¨ C/C++ æ¥å®ç°ï¼š</p>
<pre><code class="language-c">#include &lt;jni.h&gt;
#include &lt;stdio.h&gt;
#include &quot;NativeExample.h&quot;

JNIEXPORT void JNICALL Java_NativeExample_sayHello(JNIEnv *env, jobject obj) {
    printf(&quot;Hello from native C code!\n&quot;);
}
</code></pre>
<hr>
<h3>ğŸš€ å¦‚ä½•ä½¿ç”¨ native æ–¹æ³•ï¼ˆæµç¨‹æ¦‚è§ˆï¼‰</h3>
<ol>
<li>åœ¨ Java ä¸­å£°æ˜ <code>native</code> æ–¹æ³•ï¼›</li>
<li>ä½¿ç”¨ <code>javac</code> ç¼–è¯‘ Java æ–‡ä»¶ï¼›</li>
<li>ä½¿ç”¨ <code>javah</code>ï¼ˆæˆ– <code>javac -h</code>ï¼‰ç”Ÿæˆ C å¤´æ–‡ä»¶ï¼›</li>
<li>ç¼–å†™å¯¹åº”çš„ C/C++ å®ç°ä»£ç ï¼›</li>
<li>ç¼–è¯‘ç”Ÿæˆå…±äº«åº“ï¼ˆå¦‚ <code>.dll</code> / <code>.so</code> / <code>.dylib</code>ï¼‰ï¼›</li>
<li>åœ¨ Java ä¸­ä½¿ç”¨ <code>System.loadLibrary</code> åŠ è½½ï¼›</li>
<li>è¿è¡Œ Java ç¨‹åºï¼Œè°ƒç”¨ native æ–¹æ³•ã€‚</li>
</ol>
<hr>
<h3>âš ï¸ æ³¨æ„äº‹é¡¹</h3>
<ul>
<li><code>native</code> æ–¹æ³•æœ¬èº«æ²¡æœ‰æ–¹æ³•ä½“ï¼Œæ–¹æ³•ä½“åœ¨ C/C++ ä¸­å®ç°ï¼›</li>
<li>native æ–¹æ³•æ˜¯ Java å’Œåº•å±‚ç³»ç»Ÿä¹‹é—´çš„æ¡¥æ¢ï¼Œä½† <strong>ä¸å®‰å…¨ã€ä¸è·¨å¹³å°ã€éš¾è°ƒè¯•</strong>ï¼›</li>
<li>åœ¨ Java é‡Œè°ƒç”¨ native æ–¹æ³•æ—¶ï¼Œå¦‚æœå‚æ•°æˆ–æŒ‡é’ˆå¤„ç†å‡ºé”™ï¼Œå¯èƒ½å¯¼è‡´ <strong>å´©æºƒï¼ˆJVM core dumpï¼‰</strong>ã€‚</li>
</ul>
<hr>
<h3>âœ… å¸¸è§çš„ native æ–¹æ³•ä¾‹å­</h3>
<p>Java æ ‡å‡†åº“ä¸­æœ‰å¾ˆå¤š native æ–¹æ³•ï¼Œæ¯”å¦‚ï¼š</p>
<pre><code class="language-java">public final class System {
    public static native long currentTimeMillis(); // è·å–ç³»ç»Ÿæ—¶é—´
}
</code></pre>
<hr>
<h3>æ€»ç»“ä¸€å¥è¯ï¼š</h3>
<blockquote>
<p><code>native</code> æ–¹æ³• = Java å£°æ˜ + C/C++ å®ç°ï¼Œç”¨æ¥åš Java åšä¸äº†çš„åº•å±‚äº‹ã€‚</p>
</blockquote>

            </div>
        </div>
    </article>

    <script src="../../scripts/highlight.js"></script>
    <script src="../../scripts/post-enhance.js"></script>
    <script src="../../scripts/reading-toolbar.js"></script>
</body>
</html>